<!DOCTYPE html>
<!-- saved from url=(0037)http://www.jianshu.com/p/92a61357164b -->
<html class=" js flexbox flexboxlegacy canvas canvastext webgl no-touch geolocation postmessage websqldatabase indexeddb hashchange history draganddrop websockets rgba hsla multiplebgs backgroundsize borderimage borderradius boxshadow textshadow opacity cssanimations csscolumns cssgradients cssreflections csstransforms csstransforms3d csstransitions fontface generatedcontent video audio localstorage sessionstorage webworkers applicationcache svg inlinesvg smil svgclippaths"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="description" content="OkHttp系列文章如下OkHttp3源码分析[综述]OkHttp3源码分析[复用连接池]OkHttp3源码分析[缓存策略]OkHttp3源码分析[DiskLruCache]OkHttp3源码分析[任务队列]1.概述HTTP中的keepalive连接在网络性能优化中，对于延迟降低与速度提升的有非常重要的作用。通常我们进行http连接时，首先进行tcp握手，然后传输数据，最后释放图源:Nginxclosed这种方法的确简单，但是在复杂的网络内容中就不够用了，创建socket需要...">
  <meta property="wb:webmaster" content="294ec9de89e7fadb">
  <meta property="qc:admins" content="104102651453316562112116375">
  <meta property="qc:admins" content="11635613706305617">
  <meta property="qc:admins" content="1163561616621163056375">
  <meta name="google-site-verification" content="cV4-qkUJZR6gmFeajx_UyPe47GW9vY6cnCrYtCHYNh4">
  <meta name="google-site-verification" content="HF7lfF8YEGs1qtCE-kPml8Z469e2RHhGajy6JPVy5XI">
  <meta http-equiv="mobile-agent" content="format=html5; url=http://www.jianshu.com/p/92a61357164b">
    <!--  Meta for Smart App Banner -->
  <meta name="apple-itunes-app" content="app-id=888237539, app-argument=jianshu://notes/2840763">
  <!-- End -->

  <!--  Meta for Twitter Card -->
  <meta content="summary" property="twitter:card">
  <meta content="@jianshucom" property="twitter:site">
  <meta content="OkHttp3源码分析[复用连接池]" property="twitter:title">
  <meta content="OkHttp系列文章如下OkHttp3源码分析[综述]OkHttp3源码分析[复用连接池]OkHttp3源码分析[缓存策略]OkHttp3源码分析[DiskLruCache]OkHttp3源码分析[任务队列]1.概述HTTP中的keepalive连接在网络性能优化中，对于延迟降低与速度提升的有非常重要的作用。通常我们进行http连接时，首先进行tcp握手，然后传输数据，最后释放图源:Nginxclosed这种方法的确简单，但是在复杂的网络内容中就不够用了，创建socket需要..." property="twitter:description">
  <meta content="http://www.jianshu.com/p/92a61357164b" property="twitter:url">
  <!-- End -->

  <!--  Meta for OpenGraph -->
  <meta property="fb:app_id" content="865829053512461">
  <meta property="og:site_name" content="简书">
  <meta property="og:title" content="OkHttp3源码分析[复用连接池]">
  <meta property="og:type" content="article">
  <meta property="og:url" content="http://www.jianshu.com/p/92a61357164b">
  <meta property="og:description" content="OkHttp系列文章如下OkHttp3源码分析[综述]OkHttp3源码分析[复用连接池]OkHttp3源码分析[缓存策略]OkHttp3源码分析[DiskLruCache]OkHttp3源码分...">

    <meta property="og:image" content="http://upload-images.jianshu.io/upload_images/98641-9c8a016af59f675f.png">
    <meta property="og:image:width" content="1331">
    <meta property="og:image:height" content="96">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image" content="http://upload-images.jianshu.io/upload_images/98641-71b1fdaf78b8442c.png">
    <meta property="og:image:width" content="1484">
    <meta property="og:image:height" content="234">
    <meta property="og:image:type" content="image/png">
  <!-- End -->

  <!--  Meta for Facebook Applinks -->
  <meta property="al:ios:url" content="jianshu://notes/2840763">
  <meta property="al:ios:app_store_id" content="888237539">
  <meta property="al:ios:app_name" content="简书">

  <meta property="al:android:url" content="jianshu://notes/2840763">
  <meta property="al:android:package" content="com.jianshu.haruki">
  <meta property="al:android:app_name" content="简书">
  <!-- End -->

  <title>OkHttp3源码分析[复用连接池] - 简书</title>
  <meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="FR4Y/Amf4GJjsGlvO9yqlfaPZ16JGI9uXqPEI4TuBX2s9fXGuVAakH6qEI4ddIoQo14etOITaGVbBjKwfltBDA==">
  <!--[if lte IE 8]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <link rel="stylesheet" media="all" href="./OkHttp3源码分析[复用连接池] - 简书_files/base-f935477e8faba16f29c6f9e4f0e1d032.css">

    <link rel="stylesheet" media="all" href="./OkHttp3源码分析[复用连接池] - 简书_files/reading-note-4158a6eeb7c4e4a9fd15332778cfb52c.css">
  <link rel="stylesheet" media="all" href="./OkHttp3源码分析[复用连接池] - 简书_files/base-read-mode-64acccf6966299cfa3d580140a2582fe.css">
  <script src="./OkHttp3源码分析[复用连接池] - 简书_files/push.js"></script><script type="text/javascript" async="" src="./OkHttp3源码分析[复用连接池] - 简书_files/ga.js"></script><script src="./OkHttp3源码分析[复用连接池] - 简书_files/hm.js"></script><script src="./OkHttp3源码分析[复用连接池] - 简书_files/modernizr-613ea63b5aa2f0e2a1946e9c28c8eedb.js"></script>
  <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
  <!--[if IE 8]><link rel="stylesheet" media="all" href="http://cdn-qn0.jianshu.io/assets/scaffolding/for_ie-7f1c477ffedc13c11315103e8787dc6c.css" /><![endif]-->
  <!--[if lt IE 9]><link rel="stylesheet" media="all" href="http://cdn-qn0.jianshu.io/assets/scaffolding/for_ie-7f1c477ffedc13c11315103e8787dc6c.css" /><![endif]-->
  <link href="http://baijii-common.b0.upaiyun.com/icons/favicon.ico" rel="icon">
      <link rel="apple-touch-icon-precomposed" href="http://cdn-qn0.jianshu.io/assets/apple-touch-icons/57-b426758a1fcfb30486f20fd073c3b8ec.png" sizes="57x57">
      <link rel="apple-touch-icon-precomposed" href="http://cdn-qn0.jianshu.io/assets/apple-touch-icons/72-feca4b183b9d29fd188665785dc7a7f1.png" sizes="72x72">
      <link rel="apple-touch-icon-precomposed" href="http://cdn-qn0.jianshu.io/assets/apple-touch-icons/76-ba757f1ad3421192ce7192170393d2b0.png" sizes="76x76">
      <link rel="apple-touch-icon-precomposed" href="./OkHttp3源码分析[复用连接池] - 简书_files/114-8dae53b3bcea3f06bb139e329d1edab3.png" sizes="114x114">
      <link rel="apple-touch-icon-precomposed" href="http://cdn-qn0.jianshu.io/assets/apple-touch-icons/120-fa315ee0177dba4c55d4f66d4129b47f.png" sizes="120x120">
      <link rel="apple-touch-icon-precomposed" href="http://cdn-qn0.jianshu.io/assets/apple-touch-icons/152-052f5799bec8fb3aa624bdc72ef5bd1d.png" sizes="152x152">
  <!-- Baidu stats -->
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?0c0e9d9b1e7d617b3e6842e85b9fb068";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
  </script>
<style type="text/css"></style></head>

<body class="post output zh cn win reader-day-mode reader-font2" data-js-module="note-show" data-locale="zh-CN">
  
  <div class="navbar navbar-jianshu shrink hide-wrap-btn">
  <div class="dropdown">
    <a class="dropdown-toggle logo" id="dLabel" role="button" data-toggle="dropdown" data-target="#" href="javascript:void(0)">
      简
    </a>
    <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
      <li><a href="http://www.jianshu.com/"><i class="fa fa-home"></i> 首页</a></li>
      <li><a href="http://www.jianshu.com/collections"><i class="fa fa-th"></i> 专题</a></li>
      <li><a href="http://www.jianshu.com/user_invitations"><i class="fa fa-money"></i> 发钱啦</a></li>
    </ul>
  </div>
</div>
<div class="navbar-user">
    <a class="login" data-signup-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_up">
      <i class="fa fa-user"></i> 注册
</a>    <a class="login" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in">
      <i class="fa fa-sign-in"></i> 登录
</a>    <a class="daytime set-view-mode pull-right" href="javascript:void(0)"><i class="fa fa-moon-o"></i></a>
</div>
<div class="navbar navbar-jianshu expanded">
  <div class="dropdown">
      <a class="active logo" role="button" data-original-title="个人主页" data-container="div.expanded" href="http://www.jianshu.com/">
        <b>简</b><i class="fa fa-home"></i><span class="title">首页</span>
</a>      <a data-toggle="tooltip" data-placement="right" data-original-title="专题" data-container="div.expanded" href="http://www.jianshu.com/collections">
        <i class="fa fa-th"></i><span class="title">专题</span>
</a>    <a class="ad-selector" href="http://www.jianshu.com/apps">
      <i class="fa fa-mobile"></i><span class="title">下载手机应用</span>
</a>    <div class="ad-container " style="display: none;">
      <div class="ad-pop">
        <img class="ad-logo" src="./OkHttp3源码分析[复用连接池] - 简书_files/114-8dae53b3bcea3f06bb139e329d1edab3.png" alt="114">
        <p class="ad-title">简书</p>
        <p class="ad-subtitle">交流故事，沟通想法</p>
        <img class="ad-qrcode" src="./OkHttp3源码分析[复用连接池] - 简书_files/download-app-qrcode-053849fa25f9b44573ef8dd3c118a20f.png" alt="Download app qrcode">
        <div>
          <a class="ad-link" href="https://itunes.apple.com/cn/app/jian-shu/id888237539?ls=1&amp;mt=8">iOS</a>·
          <a class="ad-link" href="http://downloads.jianshu.io/apps/haruki/JianShu-1.10.8.apk">Android</a>
        </div>
      </div> 
    </div>
  </div>
  <div class="nav-user">
      <a href="http://www.jianshu.com/p/92a61357164b#view-mode-modal" data-toggle="modal"><i class="fa fa-font"></i><span class="title">显示模式</span></a>

      <a class="signin" data-signin-link="true" data-toggle="modal" data-placement="right" data-original-title="登录" data-container="div.expanded" href="http://www.jianshu.com/sign_in">
        <i class="fa fa-sign-in"></i><span class="title">登录</span>
</a>    </div>
  </div>

  
    <div class="fixed-btn">
    <a class="go-top" href="http://www.jianshu.com/p/92a61357164b#"> <i class="fa fa-angle-up"></i></a>
    <a class="qrcode" data-target="#bottom-qrcode" data-toggle="modal" href="javascript:void(0)"><i class="fa fa-qrcode"></i></a>
    <a class="writer" href="http://www.jianshu.com/writer#/" data-toggle="tooltip" data-placement="left" title="" data-original-title="写篇文章"><i class="fa fa-pencil"></i></a>
    <!-- qrcode modal -->
    <div id="bottom-qrcode" class="modal panel-modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
      <h4>下载简书移动应用</h4>
      <div class="panel-body"><img src="./OkHttp3源码分析[复用连接池] - 简书_files/download-app-qrcode-85008f146773a25ce86bcc4d7858af68.png" alt="Download app qrcode"></div>
    </div>
  </div>


  <div id="show-note-container" class="imagebubble-container imagebubble-mode-off">
    
<div class="post-bg" id="flag">
  <div class="wrap-btn hide-wrap-btn" style="top: -1px;">
    <!-- Notebook and collections button upper left -->
      <div class="article-related pull-left">
          <a class="collection-menu-btn" data-toggle="modal" data-target="#collection-menu" href="javascript:void(null);">
            <i class="fa fa-th"></i>
</a>          <a class="notebooks-menu-btn" data-toggle="modal" data-target="#notebooks-menu" href="javascript:void(null);"><i class="fa fa-list-ul"></i></a>
        <div class="related-avatar-group activities"></div>
      </div>
    <!-- ******* -->

      <a class="login" data-signup-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_up">
    <i class="fa fa-user"></i> 注册
</a>  <a class="login" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in">
    <i class="fa fa-sign-in"></i> 登录
</a>

    <!-- Buttons upper right -->
    <!-- ******* -->
  </div>

  <div class="container">
    <!-- Article activities for width under 768px -->
    <div class="related-avatar-group activities"></div>
      <div class="article">
        <div class="preview">
          <div class="author-info">
              <div class="btn btn-small btn-success follow">
    <a data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in"><i class="fa fa-plus"></i>  <span>添加关注</span></a>
  </div>

            <a class="avatar" href="http://www.jianshu.com/users/b99b0edd4e77">
              <img src="./OkHttp3源码分析[复用连接池] - 简书_files/f18dde4989b6.jpeg" alt="100">
</a>            <span class="label">
                作者
            </span>
            <a class="author-name blue-link" href="http://www.jianshu.com/users/b99b0edd4e77">
              <span>BlackSwift</span>
</a>              <span data-toggle="tooltip" data-original-title="最后编辑于 2016.03.21 22:05">2016.01.16 00:15*</span>
            <div>
              <span>写了90662字</span>，<span>被1180人关注</span>，<span>获得了1411个喜欢</span>
            </div>
          </div>
          <h1 class="title">OkHttp3源码分析[复用连接池]</h1>
          <div class="meta-top">
            <span class="wordage">字数2897</span>
            <span class="views-count">阅读2237</span>
            <span class="comments-count">评论8</span>
            <span class="likes-count">喜欢21</span>
          </div>

          <!-- Collection/Bookmark/Share for width under 768px -->
          <div class="article-share"><a class="bookmark" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in"> <i class="fa fa-bookmark-o"></i><span>收藏文章</span></a><span> <a href="javascript:void(null)" data-toggle="dropdown"><i class="fa fa-share-square-o"></i> 分享</a> <ul class="dropdown-menu arrow-top"> <li> <a href="javascript:void((function(s,d,e,r,l,p,t,z,c){var%20f=&#39;http://v.t.sina.com.cn/share/share.php?appkey=1881139527&#39;,u=z||d.location,p=[&#39;&amp;url=&#39;,e(u),&#39;&amp;title=&#39;,e(t||d.title),&#39;&amp;source=&#39;,e(r),&#39;&amp;sourceUrl=&#39;,e(l),&#39;&amp;content=&#39;,c||&#39;gb2312&#39;,&#39;&amp;pic=&#39;,e(p||&#39;&#39;)].join(&#39;&#39;);function%20a(){if(!window.open([f,p].join(&#39;&#39;),&#39;mb&#39;,[&#39;toolbar=0,status=0,resizable=1,width=440,height=430,left=&#39;,(s.width-440)/2,&#39;,top=&#39;,(s.height-430)/2].join(&#39;&#39;)))u.href=[f,p].join(&#39;&#39;);};if(/Firefox/.test(navigator.userAgent))setTimeout(a,0);else%20a();})(screen,document,encodeURIComponent,&#39;&#39;,&#39;&#39;,&#39;http://cwb.assets.jianshu.io/notes/images/2840763/weibo/image_638336a9507b.jpg&#39;, &#39;推荐 @漆黑的燕 的文章《OkHttp3源码分析[复用连接池]》（ 分享自 @简书 ）&#39;,&#39;http://www.jianshu.com/p/92a61357164b&#39;,&#39;页面编码gb2312|utf-8默认gb2312&#39;));"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/weibo.png"> </a> </li> <li> <a href="javascript:void(function(){var d=document,e=encodeURIComponent,s1=window.getSelection,s2=d.getSelection,s3=d.selection,s=s1?s1():s2?s2():s3?s3.createRange().text:&#39;&#39;,r=&#39;http://www.douban.com/recommend/?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;title=&#39;+e(&#39;OkHttp3源码分析[复用连接池]&#39;)+&#39;&amp;sel=&#39;+e(s)+&#39;&amp;v=1&#39;,x=function(){if(!window.open(r,&#39;douban&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330&#39;))location.href=r+&#39;&amp;r=1&#39;};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})()"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/douban.png"> </a> </li> <li> <a href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;http://share.v.t.qq.com/index.php?c=share&amp;a=index&amp;url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;title=&#39;+e(&#39;推荐 BlackSwift 的文章《OkHttp3源码分析[复用连接池]》（ 分享自 @jianshuio ）&#39;),x=function(){if(!window.open(r,&#39;tweibo&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=600,height=600&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/tweibo.png"> </a> </li> <li> <a href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;title=&#39;+e(&#39;推荐 BlackSwift 的文章《OkHttp3源码分析[复用连接池]》&#39;),x=function(){if(!window.open(r,&#39;qzone&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=600,height=600&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/qzone.png"> </a> </li> <li> <a href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;https://twitter.com/share?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;text=&#39;+e(&#39;推荐 BlackSwift 的文章《OkHttp3源码分析[复用连接池]》（ 分享自 @jianshucom ）&#39;)+&#39;&amp;related=&#39;+e(&#39;jianshucom&#39;),x=function(){if(!window.open(r,&#39;twitter&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=600,height=600&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/twitter.png"> </a> </li> <li> <a href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;https://www.facebook.com/dialog/share?app_id=483126645039390&amp;display=popup&amp;href=http://www.jianshu.com/p/92a61357164b&#39;,x=function(){if(!window.open(r,&#39;facebook&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/facebook.png"> </a> </li> <li> <a href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;https://plus.google.com/share?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;),x=function(){if(!window.open(r,&#39;google_plus&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/google_plus.png"> </a> </li> <li> <a href="http://www.jianshu.com/p/92a61357164b"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/renren.png"> </a> </li> </ul></span></div>
          <!-- -->

          <div class="show-content"><p>OkHttp系列文章如下</p>
<ul>
<li><a href="http://www.jianshu.com/p/aad5aacd79bf" target="_blank">OkHttp3源码分析[综述]</a></li>
<li><a href="http://www.jianshu.com/p/92a61357164b" target="_blank">OkHttp3源码分析[复用连接池]</a></li>
<li><a href="http://www.jianshu.com/p/9cebbbd0eeab" target="_blank">OkHttp3源码分析[缓存策略]</a></li>
<li><a href="http://www.jianshu.com/p/23b8aa490a6b" target="_blank">OkHttp3源码分析[DiskLruCache]</a></li>
<li><a href="http://www.jianshu.com/p/6637369d02e7" target="_blank">OkHttp3源码分析[任务队列]</a></li>
</ul>
<hr>
<h2>1. 概述</h2>
<p>HTTP中的<code>keepalive连接</code>在网络性能优化中，对于延迟降低与速度提升的有非常重要的作用。</p>
<p>通常我们进行http连接时，首先进行tcp握手，然后传输数据，最后释放</p>
<div class="image-package imagebubble" widget="ImageBubble">
<img src="./OkHttp3源码分析[复用连接池] - 简书_files/98641-9c8a016af59f675f.png" data-original-src="http://upload-images.jianshu.io/upload_images/98641-9c8a016af59f675f.png?imageMogr2/auto-orient/strip%7CimageView2/2" class="imagebubble-image" style="opacity: 1;"><br><div class="image-caption">图源: Nginx closed</div>
</div>
<p>这种方法的确简单，但是在复杂的网络内容中就不够用了，创建socket需要进行3次握手，而释放socket需要2次握手(或者是4次)。重复的连接与释放tcp连接就像每次仅仅挤1mm的牙膏就合上牙膏盖子接着再打开接着挤一样。而每次连接大概是TTL一次的时间(也就是ping一次)，甚至在TLS环境下消耗的时间就更多了。很明显，当访问复杂网络时，延时（而不是带宽）将成为非常重要的因素。</p>
<p>当然，上面的问题早已经解决了，在http中有一种叫做<code>keepalive connections</code>的机制，它可以在传输数据后仍然保持连接，当客户端需要再次获取数据时，直接使用刚刚空闲下来的连接而不需要再次握手</p>
<div class="image-package imagebubble" widget="ImageBubble">
<img src="./OkHttp3源码分析[复用连接池] - 简书_files/98641-71b1fdaf78b8442c.png" data-original-src="http://upload-images.jianshu.io/upload_images/98641-71b1fdaf78b8442c.png?imageMogr2/auto-orient/strip%7CimageView2/2" class="imagebubble-image"><br><div class="image-caption" style="opacity: 1;">图源: Nginx keep_alive</div>
</div>
<p>在现代浏览器中，一般同时开启6～8个<code>keepalive connections</code>的socket连接，并保持一定的链路生命，当不需要时再关闭；而在服务器中，一般是由软件根据负载情况进行配置。</p>
<blockquote><p>Okhttp支持5个并发，默认链路生命为5分钟(链路空闲后，保持存活的时间)</p></blockquote>
<p>当然keepalive也有缺点，在提高了单个客户端性能的同时，复用却阻碍了其他客户端的链路速度，具体来说如下</p>
<ol>
<li>根据TCP的拥塞机制，当总水管大小固定时，如果存在大量空闲的<code>keepalive connections</code>（我们可以称作<code>僵尸连接</code>或者<code>泄漏连接</code>），其它客户端们的正常连接速度也会受到影响</li>
<li>服务器/防火墙上有并发限制，比如<code>apache</code>服务器只支持150个并发连接（数据来源于nginx官网），不过这个瓶颈随着高并发server软硬件的发展（golang/分布式）将会越来越少</li>
<li>大量的DDOS产生的僵尸连接可能被用于恶意攻击服务器，耗尽资源</li>
</ol>
<p>好了，以上科普完毕，本文主要是写客户端的，服务端不再介绍。</p>
<p>下文假设服务器是经过专业的运维配置好的，它默认开启了<code>keep-alive</code>，并不主动关闭连接</p>
<h2>2. 连接池的使用与分析</h2>
<p>首先先说下源码中关键的对象：</p>
<ul>
<li>
<code>Call</code>: 对http的请求封装，属于上层高级代码</li>
<li>
<code>Connection</code>: 对jdk的socket物理连接的包装，它内部有<code>List&lt;WeakReference&lt;StreamAllocation&gt;&gt;</code>的引用</li>
<li>
<code>StreamAllocation</code>: 表示<code>Connection</code>被上层高级代码的引用次数</li>
<li>
<code>ConnectionPool</code>: Socket连接池，对连接缓存进行回收与管理</li>
<li>
<code>Deque</code>: Deque也就是双端队列，双端队列同时具有队列和栈性质，经常在缓存中被使用，这个是java基础</li>
</ul>
<p>在okhttp中，连接池对用户，甚至开发者都是透明的。它自动创建连接池，自动进行泄漏连接回收，自动帮你管理线程池，提供了put/get/clear的接口，甚至调用都帮你写好了。</p>
<p>在以前的内存泄露<a href="http://www.jianshu.com/p/c59c199ca9fa" target="_blank">分析文章</a>中我写到，我们知道在socket连接中，也就是<code>Connection</code>中，本质是封装好的流操作，除非手动<code>close</code>，基本不会被gc掉，非常容易引发内存泄露。所以当涉及到并发socket编程时，我们就会非常紧张，往往写出来的代码都是<code>try/catch/finally</code>的迷之缩进，却又对这样的代码无可奈何。</p>
<p>在okhttp中，在高层代码的调用中，使用了类似于引用计数的方式跟踪流的调用，这里的计数对象是<code>StreamAllocation</code>，它被反复执行<a href="https://github.com/square/okhttp/blob/c64e3426a326fdf61a6f9859292a45845186e790/okhttp/src/main/java/okhttp3/internal/http/StreamAllocation.java#L296-L296" target="_blank"><code>aquire</code></a>与<a href="https://github.com/square/okhttp/blob/c64e3426a326fdf61a6f9859292a45845186e790/okhttp/src/main/java/okhttp3/internal/http/StreamAllocation.java#L301-L301" target="_blank"><code>release</code></a>操作(点击函数可以进入github查看)，这两个函数其实是在改变<code>Connection</code>中的<code>List&lt;WeakReference&lt;StreamAllocation&gt;&gt;</code>大小。<code>List</code>中Allocation的数量也就是物理socket被引用的计数（Refference Count），如果计数为0的话，说明此连接没有被使用，是空闲的，需要通过下文的算法实现回收；如果上层代码仍然引用，就不需要关闭连接。</p>
<blockquote><p>引用计数法：给对象中添加一个引用计数器，每当有一个地方引用它时，计数器值就加1；当引用失效时，计数器值就减1；任何时刻计数器为0的对象就是不可能再被使用。它不能处理循环引用的问题。</p></blockquote>
<h4>2.1. 实例化</h4>
<p>在源码中，我们先找<code>ConnectionPool</code>实例化的位置，它是直接new出来的，而它的各种操作却在<code>OkHttpClient</code>的<a href="https://github.com/square/okhttp/blob/ee83d8d26afd92d27fbcd2a328e882f25a5090c6/okhttp/src/main/java/okhttp3/OkHttpClient.java#L65-L65" target="_blank">static区</a>实现了<code>Internal.instance</code>接口作为<code>ConnectionPool</code>的包装。</p>
<blockquote><p>至于为什么需要这么多此一举的分层包装，主要是为了让外部包的成员访问非<code>public</code>方法，详见这里<a href="https://github.com/square/okhttp/blob/21d63034188d90ca51d635be348d5deba4abeca3/okhttp/src/main/java/okhttp3/internal/Internal.java#L34-L34" target="_blank">注释</a></p></blockquote>
<h4>2.2. 构造</h4>
<ol>
<li>
<p>连接池内部维护了一个叫做<code>OkHttp ConnectionPool</code>的<code>ThreadPool</code>，专门用来淘汰末位的socket，当满足以下条件时，就会进行末位淘汰，非常像GC</p>
<pre class="hljs cpp"><code class="cpp"> <span class="hljs-number">1.</span> 并发socket空闲连接超过<span class="hljs-number">5</span>个
 <span class="hljs-number">2.</span> 某个socket的keepalive时间大于<span class="hljs-number">5</span>分钟</code></pre>
</li>
<li>
<p>维护着一个<code>Deque&lt;Connection&gt;</code>，提供get/put/remove等数据结构的功能</p>
</li>
<li>
<p>维护着一个<code>RouteDatabase</code>，它用来记录连接失败的<code>Route</code>的黑名单，当连接失败的时候就会把失败的线路加进去（本文不讨论）</p>
</li>
</ol>
<h4>2.3 put/get操作</h4>
<p>在连接池中，提供如下的操作，这里可以看成是对deque的一个简单的包装</p>
<pre class="hljs cs"><code class="cs"><span class="hljs-comment">//从连接池中获取</span>
<span class="hljs-keyword">get</span>
<span class="hljs-comment">//放入连接池</span>
put
<span class="hljs-comment">//线程变成空闲，并调用清理线程池</span>
connectionBecameIdle
<span class="hljs-comment">//关闭所有连接</span>
evictAll</code></pre>
<p>随着上述操作被更高级的对象调用，<code>Connection</code>中的<code>StreamAllocation</code>被不断的<a href="https://github.com/square/okhttp/blob/c64e3426a326fdf61a6f9859292a45845186e790/okhttp/src/main/java/okhttp3/internal/http/StreamAllocation.java#L296-L296" target="_blank"><code>aquire</code></a>与<a href="https://github.com/square/okhttp/blob/c64e3426a326fdf61a6f9859292a45845186e790/okhttp/src/main/java/okhttp3/internal/http/StreamAllocation.java#L301-L301" target="_blank"><code>release</code></a>，也就是<code>List&lt;WeakReference&lt;StreamAllocation&gt;&gt;</code>的大小将时刻变化</p>
<h4>2.4 Connection自动回收的实现</h4>
<p>java内部有垃圾回收GC，okhttp有socket回收SocketClean；垃圾回收是根据对象的引用树实现的，而okhttp是根据<code>RealConnection</code>的虚引用<code>StreamAllocation</code>引用计数是否为0实现的。</p>
<p>cleanupRunnable:</p>
<p>当用户socket连接成功，向连接池中<code>put</code>新的socket时，回收函数会被主动调用，线程池就会执行<code>cleanupRunnable</code>，如下</p>
<pre class="hljs cpp"><code class="cpp"><span class="hljs-comment">//Socket清理的Runnable，每当put操作时，就会被调用</span>
<span class="hljs-comment">//注意put操作是在网络线程</span>
<span class="hljs-comment">//而Socket清理是在`OkHttp ConnectionPool`线程池中调用</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">//执行清理并返回下场需要清理的时间</span>
  <span class="hljs-keyword">long</span> waitNanos = cleanup(System.nanoTime());
  <span class="hljs-keyword">if</span> (waitNanos == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">if</span> (waitNanos &gt; <span class="hljs-number">0</span>) {
    synchronized (ConnectionPool.<span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">//在timeout内释放锁与时间片</span>
        ConnectionPool.<span class="hljs-keyword">this</span>.wait(TimeUnit.NANOSECONDS.toMillis(waitNanos));
      } <span class="hljs-keyword">catch</span> (InterruptedException ignored) {
      }
    }
  }
}</code></pre>
<p>这段死循环实际上是一个阻塞的清理任务，首先进行清理(clean)，并返回下次需要清理的间隔时间，然后调用<code>wait(timeout)</code>进行等待以释放锁与时间片，当等待时间到了后，再次进行清理，并返回下次要清理的间隔时间...</p>
<p>Cleanup:</p>
<p><a href="https://github.com/square/okhttp/blob/7826bcb2fb1facb697a4c512776756c05d8c9deb/okhttp/src/main/java/okhttp3/ConnectionPool.java#L183-L183" target="_blank">cleanup</a>使用了类似于GC的<code>标记-清除算法</code>，也就是首先标记出最不活跃的连接(我们可以叫做<code>泄漏连接</code>，或者<code>空闲连接</code>)，接着进行清除，流程如下:</p>
<pre class="hljs cpp"><code class="cpp"><span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">cleanup</span><span class="hljs-params">(<span class="hljs-keyword">long</span> now)</span> </span>{
  <span class="hljs-keyword">int</span> inUseConnectionCount = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">int</span> idleConnectionCount = <span class="hljs-number">0</span>;
  RealConnection longestIdleConnection = null;
  <span class="hljs-keyword">long</span> longestIdleDurationNs = Long.MIN_VALUE;

  <span class="hljs-comment">//遍历`Deque`中所有的`RealConnection`，标记泄漏的连接</span>
  synchronized (<span class="hljs-keyword">this</span>) {
    <span class="hljs-keyword">for</span> (RealConnection connection : connections) {
      <span class="hljs-comment">// 查询此连接内部StreamAllocation的引用数量</span>
      <span class="hljs-keyword">if</span> (pruneAndGetAllocationCount(connection, now) &gt; <span class="hljs-number">0</span>) {
        inUseConnectionCount++;
        <span class="hljs-keyword">continue</span>;
      }

      idleConnectionCount++;

      <span class="hljs-comment">//选择排序法，标记出空闲连接</span>
      <span class="hljs-keyword">long</span> idleDurationNs = now - connection.idleAtNanos;
      <span class="hljs-keyword">if</span> (idleDurationNs &gt; longestIdleDurationNs) {
        longestIdleDurationNs = idleDurationNs;
        longestIdleConnection = connection;
      }
    }

    <span class="hljs-keyword">if</span> (longestIdleDurationNs &gt;= <span class="hljs-keyword">this</span>.keepAliveDurationNs
        || idleConnectionCount &gt; <span class="hljs-keyword">this</span>.maxIdleConnections) {
      <span class="hljs-comment">//如果(`空闲socket连接超过5个`</span>
      <span class="hljs-comment">//且`keepalive时间大于5分钟`)</span>
      <span class="hljs-comment">//就将此泄漏连接从`Deque`中移除</span>
      connections.remove(longestIdleConnection);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idleConnectionCount &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">//返回此连接即将到期的时间，供下次清理</span>
      <span class="hljs-comment">//这里依据是在上文`connectionBecameIdle`中设定的计时</span>
      <span class="hljs-keyword">return</span> keepAliveDurationNs - longestIdleDurationNs;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (inUseConnectionCount &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">//全部都是活跃的连接，5分钟后再次清理</span>
      <span class="hljs-keyword">return</span> keepAliveDurationNs;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">//没有任何连接，跳出循环</span>
      cleanupRunning = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
  }

  <span class="hljs-comment">//关闭连接，返回`0`，也就是立刻再次清理</span>
  closeQuietly(longestIdleConnection.socket());
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
<ol>
<li>遍历<code>Deque</code>中所有的<code>RealConnection</code>，标记泄漏的连接</li>
<li>如果被标记的连接(<code>空闲socket连接超过5个</code>&amp;&amp;<code>keepalive时间大于5分钟</code>),就将此泄漏连接从<code>Deque</code>中移除，并关闭连接，返回<code>0</code>，也就是将要执行<code>wait(0)</code>，提醒立刻再次扫描</li>
<li>如果(<code>目前还可以塞得下5个连接，但是有可能泄漏的连接(即空闲时间即将达到5分钟)</code>)，就返回此连接即将到期的时间，供下次清理</li>
<li>如果(<code>全部都是活跃的连接</code>)，就返回默认的<code>keep-alive</code>时间，也就是5分钟后再执行清理</li>
<li>如果(<code>没有任何连接</code>)，就返回<code>-1</code>,跳出清理的死循环</li>
</ol>
<blockquote><p>再次注意：这里的“并发”==(“空闲”＋“活跃”)==5，而不是说并发连接就一定是活跃的连接</p></blockquote>
<p>pruneAndGetAllocationCount:</p>
<p>如何找到最不活跃的连接呢，这里使用了<code>pruneAndGetAllocationCount</code>的<a href="https://github.com/square/okhttp/blob/7826bcb2fb1facb697a4c512776756c05d8c9deb/okhttp/src/main/java/okhttp3/ConnectionPool.java#L238-L238" target="_blank">方法</a>,它主要依据弱引用是否为<code>null</code>而判断这个连接是否泄漏</p>
<pre class="hljs cs"><code class="cs"><span class="hljs-comment">//类似于引用计数法，如果引用全部为空，返回立刻清理</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">pruneAndGetAllocationCount</span>(<span class="hljs-params">RealConnection connection, <span class="hljs-keyword">long</span> now</span>) </span>{
  <span class="hljs-comment">//弱引用列表</span>
  List&lt;Reference&lt;StreamAllocation&gt;&gt; references = connection.allocations;
  <span class="hljs-comment">//遍历弱引用列表</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; references.size(); ) {
    Reference&lt;StreamAllocation&gt; reference = references.<span class="hljs-keyword">get</span>(i);
    <span class="hljs-comment">//如果正在被使用，跳过，接着循环</span>
    <span class="hljs-comment">//是否置空是在上文`connectionBecameIdle`的`release`手动控制的</span>
    <span class="hljs-keyword">if</span> (reference.<span class="hljs-keyword">get</span>() != <span class="hljs-keyword">null</span>) {
      <span class="hljs-comment">//非常明显的引用计数</span>
      i++;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-comment">//否则移除引用</span>
    references.remove(i);
    connection.noNewStreams = <span class="hljs-keyword">true</span>;

    <span class="hljs-comment">//如果所有分配的流均没了，标记为已经距离现在空闲了5分钟</span>
    <span class="hljs-keyword">if</span> (references.isEmpty()) {
      connection.idleAtNanos = now - keepAliveDurationNs;
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
  }

  <span class="hljs-keyword">return</span> references.size();
}</code></pre>
<ol>
<li>遍历<code>RealConnection</code>连接中的<code>StreamAllocationList</code>，它维护着一个弱应用列表</li>
<li>查看此<code>StreamAllocation</code>是否为空(它是在线程池的put/remove手动控制的)，如果为空，说明已经没有代码引用这个对象了，需要在List中删除</li>
<li>遍历结束，如果List中维护的<code>StreamAllocation</code>删空了，就返回<code>0</code>，表示这个连接已经没有代码引用了，是<code>泄漏的连接</code>;否则返回非0的值，表示这个仍然被引用，是活跃的连接。</li>
</ol>
<h2>总结</h2>
<p>通过上面的分析，我们可以总结，okhttp使用了类似于引用计数法与标记擦除法的混合使用，当连接空闲或者释放时，<code>StreamAllocation</code>的数量会渐渐变成0，从而被线程池监测到并回收，这样就可以保持多个健康的keep-alive连接，Okhttp的黑科技就是这样实现的。</p>
<p>如果你期待更多高质量的文章，不妨关注我或者点赞吧！</p>
<h2>Ref</h2>
<ol>
<li><a href="https://www.nginx.com/blog/http-keepalives-and-web-performance/" target="_blank">https://www.nginx.com/blog/http-keepalives-and-web-performance/</a></li>
</ol>
</div>
        </div>
      </div>

      <div class="visitor_edit">
        <!-- further readings -->
        <div id="further-readings" data-user-slug="" data-user-nickname="">
          <div id="further-reading-line" class="hide further-reading-line"></div>
          <ul id="further-readings-list" class="reading-list unstyled"></ul>
          <div id="further-reading-new" class="reading-edit">
              <a data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in">
                <i class="fa fa-plus-circle"></i> 推荐拓展阅读
</a>            <div id="further-reading-form"></div>
          </div>
        </div>
        <div class="pull-right">
          <!-- copyright -->
          <div class="author-copyright pull-right" data-toggle="tooltip" data-html="true" title="" data-original-title="转载请联系作者获得授权，并标注“简书作者”。">
            <a><i class="fa fa-copyright"></i> 著作权归作者所有</a>
          </div>
        </div>
      </div>

      <!-- Reward / Support Author -->
        <div class="support-author">
          <p>打赏也是按照基本法！当然读者的意见也吼重要👓</p>
            <a class="btn btn-pay" data-toggle="modal" href="http://www.jianshu.com/p/92a61357164b#pay-modal">¥ 打赏支持</a>
          <div class="avatar-list"><a href="http://www.jianshu.com/users/a260651bee80" class="avatar" data-nickname="Trity" data-created-at="2016-05-24T18:40:23+08:00" data-original-title="" title=""> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/10abd7108961.png"></a><a href="http://www.jianshu.com/users/c1b9d1faa7b5" class="avatar" data-nickname="MrFu" data-created-at="2016-01-16T11:31:56+08:00" data-original-title="" title=""> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/04777e99a3be.png"></a><a href="http://www.jianshu.com/users/df40282480b4" class="avatar" data-nickname="小鄧子" data-created-at="2016-01-16T00:50:28+08:00" data-original-title="" title=""> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/1acbdceac878.png"></a><a href="http://www.jianshu.com/users/ec59bd61433a" class="avatar" data-nickname="程序亦非猿" data-created-at="2016-01-16T00:28:58+08:00" data-original-title="" title=""> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/60959ccfd3fb"></a></div>
        </div>

      <!-- article meta bottom -->
      <div class="meta-bottom clearfix">
        <!--  Like Button -->
        <div class="like ">
            <div class="like-button">
              <a id="like-note" class="like-content" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in">
                <i class="fa fa-heart-o"></i>  喜欢
</a></div>          <span id="likes-count" data-toggle="tooltip" data-placement="right" title="" data-original-title="查看所有喜欢的用户">21</span>        </div>
        <!--  share group -->
        <div class="share-group pull-right">
          <a href="javascript:void((function(s,d,e,r,l,p,t,z,c){var%20f=&#39;http://v.t.sina.com.cn/share/share.php?appkey=1881139527&#39;,u=z||d.location,p=[&#39;&amp;url=&#39;,e(u),&#39;&amp;title=&#39;,e(t||d.title),&#39;&amp;source=&#39;,e(r),&#39;&amp;sourceUrl=&#39;,e(l),&#39;&amp;content=&#39;,c||&#39;gb2312&#39;,&#39;&amp;pic=&#39;,e(p||&#39;&#39;)].join(&#39;&#39;);function%20a(){if(!window.open([f,p].join(&#39;&#39;),&#39;mb&#39;,[&#39;toolbar=0,status=0,resizable=1,width=440,height=430,left=&#39;,(s.width-440)/2,&#39;,top=&#39;,(s.height-430)/2].join(&#39;&#39;)))u.href=[f,p].join(&#39;&#39;);};if(/Firefox/.test(navigator.userAgent))setTimeout(a,0);else%20a();})(screen,document,encodeURIComponent,&#39;&#39;,&#39;&#39;,&#39;http://cwb.assets.jianshu.io/notes/images/2840763/weibo/image_638336a9507b.jpg&#39;, &#39;推荐 @漆黑的燕 的文章《OkHttp3源码分析[复用连接池]》（ 分享自 @简书 ）&#39;,&#39;http://www.jianshu.com/p/92a61357164b&#39;,&#39;页面编码gb2312|utf-8默认gb2312&#39;));" data-name="weibo">
            <i class="fa fa-weibo"></i><span>分享到微博</span>
          </a>
          <a data-toggle="modal" href="http://www.jianshu.com/p/92a61357164b#share-weixin-modal" data-name="weixin">
            <i class="fa fa-weixin"></i><span>分享到微信</span>
          </a>
          <div class="more">
            <a href="javascript:void(0)" data-toggle="dropdown">更多分享<i class="fa fa-caret-down"></i></a>
            <ul class="dropdown-menu arrow-top">
                <li><a href="http://cwb.assets.jianshu.io/notes/images/2840763/weibo/image_638336a9507b.jpg" target="_blank" data-name="changweibo"><i class="fa fa-arrow-circle-o-down"></i> 下载长微博图片</a></li>
                <li>
                  <a data-name="tweibo" href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;http://share.v.t.qq.com/index.php?c=share&amp;a=index&amp;url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;title=&#39;+e(&#39;推荐 BlackSwift 的文章《OkHttp3源码分析[复用连接池]》（ 分享自 @jianshuio ）&#39;),x=function(){if(!window.open(r,&#39;tweibo&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=600,height=600&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();">
                    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/tweibo.png" alt="Tweibo"> 分享到腾讯微博
</a>                </li>
                <li>
                  <a data-name="qzone" href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;title=&#39;+e(&#39;推荐 BlackSwift 的文章《OkHttp3源码分析[复用连接池]》&#39;),x=function(){if(!window.open(r,&#39;qzone&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=600,height=600&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();">
                    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/qzone.png" alt="Qzone"> 分享到QQ空间
</a>                </li>
                <li>
                  <a data-name="twitter" href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;https://twitter.com/share?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;text=&#39;+e(&#39;推荐 BlackSwift 的文章《OkHttp3源码分析[复用连接池]》（ 分享自 @jianshucom ）&#39;)+&#39;&amp;related=&#39;+e(&#39;jianshucom&#39;),x=function(){if(!window.open(r,&#39;twitter&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=600,height=600&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();">
                    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/twitter.png" alt="Twitter"> 分享到Twitter
</a>                </li>
                <li>
                  <a data-name="facebook" href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;https://www.facebook.com/dialog/share?app_id=483126645039390&amp;display=popup&amp;href=http://www.jianshu.com/p/92a61357164b&#39;,x=function(){if(!window.open(r,&#39;facebook&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();">
                    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/facebook.png" alt="Facebook"> 分享到Facebook
</a>                </li>
                <li>
                  <a data-name="google_plus" href="javascript:void(function(){var d=document,e=encodeURIComponent,r=&#39;https://plus.google.com/share?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;),x=function(){if(!window.open(r,&#39;google_plus&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330&#39;))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})();">
                    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/google_plus.png" alt="Google plus"> 分享到Google+
</a>                </li>
                <li>
                  <a data-name="douban" href="javascript:void(function(){var d=document,e=encodeURIComponent,s1=window.getSelection,s2=d.getSelection,s3=d.selection,s=s1?s1():s2?s2():s3?s3.createRange().text:&#39;&#39;,r=&#39;http://www.douban.com/recommend/?url=&#39;+e(&#39;http://www.jianshu.com/p/92a61357164b&#39;)+&#39;&amp;title=&#39;+e(&#39;OkHttp3源码分析[复用连接池]&#39;)+&#39;&amp;sel=&#39;+e(s)+&#39;&amp;v=1&#39;,x=function(){if(!window.open(r,&#39;douban&#39;,&#39;toolbar=0,resizable=1,scrollbars=yes,status=1,width=450,height=330&#39;))location.href=r+&#39;&amp;r=1&#39;};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}})()">
                    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/douban.png" alt="Douban"> 分享到豆瓣
</a>                </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Modals -->
      <div id="share-weixin-modal" class="modal hide fade share-weixin-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
  </div>
  <div class="modal-body" title="http://www.jianshu.com/p/92a61357164b?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=reader_share&amp;utm_source=weixin">
    <h5>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</h5>
  <canvas width="170" height="170" style="display: none;"></canvas><img src="data:image/png;base64,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" style="display: block;"></div>
</div>

      
      <div id="notebooks-menu" class="panel notebooks-menu arrow-top modal hide fade"><img class="loader-tiny" src="./OkHttp3源码分析[复用连接池] - 简书_files/tiny.gif" alt="Tiny"></div>
      <div id="collection-menu" class="panel collection-menu arrow-top modal hide fade"><img class="loader-tiny" src="./OkHttp3源码分析[复用连接池] - 简书_files/tiny.gif" alt="Tiny"></div>
      
      <div id="likes-modal" class="modal modal_new support_list-modal fullscreen hide fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3>喜欢的用户</h3>
      </div>
      <div class="modal-body">
        <ul class="unstyled users">
        <li data-user-id="1018039"> <a class="avatar" href="http://www.jianshu.com/users/470afcb80dc2"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/f17a7f89c7ee.jpg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/470afcb80dc2">r17171709</a> <span class="time">2016.05.25 06:14</span></li><li data-user-id="2107924"> <a class="avatar" href="http://www.jianshu.com/users/827a9e13f4d0"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/ea59cd3d6b73"> </a> <a class="blue-link" href="http://www.jianshu.com/users/827a9e13f4d0">别格式化</a> <span class="time">2016.05.19 15:58</span></li><li data-user-id="459397"> <a class="avatar" href="http://www.jianshu.com/users/0b94866acc84"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/14-75d944a989bbbd5b92a639698c9b4a3c.jpg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/0b94866acc84">zy_zhangyuan88</a> <span class="time">2016.05.19 11:34</span></li><li data-user-id="1374780"> <a class="avatar" href="http://www.jianshu.com/users/d9f1b9f9f5ed"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/47ea5a4aa5e9.jpg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/d9f1b9f9f5ed">背影杀手不太冷</a> <span class="time">2016.05.16 23:52</span></li><li data-user-id="1884635"> <a class="avatar" href="http://www.jianshu.com/users/fc1ffd42765b"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/fa7475aa7786.jpg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/fc1ffd42765b">shone</a> <span class="time">2016.05.16 18:14</span></li><li data-user-id="55390"> <a class="avatar" href="http://www.jianshu.com/users/a260651bee80"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/10abd7108961.png"> </a> <a class="blue-link" href="http://www.jianshu.com/users/a260651bee80">Trity</a> <span class="time">2016.05.13 14:36</span></li><li data-user-id="591325"> <a class="avatar" href="http://www.jianshu.com/users/812627fbf13a"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/e2d763f5b76c.jpeg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/812627fbf13a">shangjing</a> <span class="time">2016.04.28 17:45</span></li><li data-user-id="730571"> <a class="avatar" href="http://www.jianshu.com/users/47888ba33f00"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/905997d3f97e.jpg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/47888ba33f00">I二师兄I</a> <span class="time">2016.04.27 18:00</span></li><li data-user-id="1921824"> <a class="avatar" href="http://www.jianshu.com/users/84cc0b56e05d"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/6e75d3748a4b.jpeg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/84cc0b56e05d">C3I</a> <span class="time">2016.04.26 13:55</span></li><li data-user-id="1874779"> <a class="avatar" href="http://www.jianshu.com/users/e0db1cc5dce5"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/3e1abc4e5c82"> </a> <a class="blue-link" href="http://www.jianshu.com/users/e0db1cc5dce5">冷若陌路</a> <span class="time">2016.04.11 10:26</span></li><li data-user-id="312424"> <a class="avatar" href="http://www.jianshu.com/users/fd456a40242c"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/e062c8834423"> </a> <a class="blue-link" href="http://www.jianshu.com/users/fd456a40242c">whatwhyhow</a> <span class="time">2016.02.24 22:26</span></li><li data-user-id="8537"> <a class="avatar" href="http://www.jianshu.com/users/yQVvot"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/f0bc1b299f5a"> </a> <a class="blue-link" href="http://www.jianshu.com/users/yQVvot">ssskeee</a> <span class="time">2016.01.28 18:48</span></li><li data-user-id="649764"> <a class="avatar" href="http://www.jianshu.com/users/8710f5ad9c7e"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/fe982e1c2612"> </a> <a class="blue-link" href="http://www.jianshu.com/users/8710f5ad9c7e">xyzmst</a> <span class="time">2016.01.22 17:06</span></li><li data-user-id="937851"> <a class="avatar" href="http://www.jianshu.com/users/6b372d09b617"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/c2143c453705.jpg"> </a> <a class="blue-link" href="http://www.jianshu.com/users/6b372d09b617">YoKey</a> <span class="time">2016.01.20 13:05</span></li><li data-user-id="1141979"> <a class="avatar" href="http://www.jianshu.com/users/f502075d96bd"> <img src="./OkHttp3源码分析[复用连接池] - 简书_files/473517ca3b0e"> </a> <a class="blue-link" href="http://www.jianshu.com/users/f502075d96bd">森Sam</a> <span class="time">2016.01.17 11:02</span></li><a class="more hidden" data-max-id="11942794" href="javascript:void(null);"><i class="fa fa-ellipsis-h"></i></a></ul>
      </div>
    </div>
  </div>
</div>



    <!-- Comments -->
    <div id="comments" class="comment-list clearfix">
        <div class="comment-head clearfix">
          8条评论
          <span class="order">
            （
            <a data-order="asc" class="active" href="javascript:void(0)">按时间正序</a>·
            <a data-order="desc" href="javascript:void(0)">按时间倒序</a>·
            <a data-order="likes_count" href="javascript:void(0)">按喜欢排序</a>
            ）
          </span>
            <a class="goto-comment pull-right" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in">
              <i class="fa fa-pencil"></i>添加新评论
</a>        </div>
        <div id="comment-list"><script type="application/json" data-name="comments-info">
  {"comments":[{"id":1243652,"children_count":2,"likes_count":0},{"id":1243707,"children_count":0,"likes_count":0},{"id":1301857,"children_count":1,"likes_count":0},{"id":1332160,"children_count":1,"likes_count":0}]}
</script>


<div class="note-comment clearfix" id="comment-1243652">
  <div class="content">
      <div class="meta-top">
        <a class="avatar" href="http://www.jianshu.com/users/df40282480b4">
          <img src="./OkHttp3源码分析[复用连接池] - 简书_files/1acbdceac878.png" alt="100">
</a>        <p>
          <a class="author-name" href="http://www.jianshu.com/users/df40282480b4">小鄧子</a>
        </p>
        <span class="reply-time">
          <small>2 楼 · </small>
          <a href="http://www.jianshu.com/p/92a61357164b/comments/1243652#comment-1243652">2016.01.16 00:19</a></span>
      </div>
      <p>这个必须顶，太棒了</p>
      <div class="comment-footer clearfix text-right">
        <a data-id="1243652" class="like pull-left" href="javascript:void(0)">
          <i class="fa fa-heart-o"></i>喜欢<span>(0)</span>
</a>        

        <a data-id="1243652" data-nickname="小鄧子" class="reply" href="javascript:void(0)">回复</a>
        
        
      </div>
    <div class="child-comment-list ">
        <div class="child-comment" id="comment-1243662" data-id="1243662">
    <p>
      <a class="blue-link" href="http://www.jianshu.com/users/b99b0edd4e77">BlackSwift</a>：
      <a href="http://www.jianshu.com/users/df40282480b4" class="maleskine-author" target="_blank" data-user-slug="df40282480b4">@小鄧子</a> 感谢网红顶 <img src="./OkHttp3源码分析[复用连接池] - 简书_files/smile.png" alt=":smile:" title=":smile:" class="emoji" width="20" height="20"> 
    </p>
    <div class="child-comment-footer text-right clearfix">
      
      <a data-id="1243652" data-nickname="BlackSwift" class="reply" href="javascript:void(null)">回复</a>
      
      
      <span class="reply-time pull-left">
        <a href="http://www.jianshu.com/p/92a61357164b/comments/1243662#comment-1243662">2016.01.16 00:20</a></span>
      
    </div>
  </div>
  <div class="child-comment" id="comment-1243665" data-id="1243665">
    <p>
      <a class="blue-link" href="http://www.jianshu.com/users/df40282480b4">小鄧子</a>：
      <a href="http://www.jianshu.com/users/b99b0edd4e77" class="maleskine-author" target="_blank" data-user-slug="b99b0edd4e77">@BlackSwift</a> 你要火 <img src="./OkHttp3源码分析[复用连接池] - 简书_files/relieved.png" alt=":relieved:" title=":relieved:" class="emoji" width="20" height="20"> 
    </p>
    <div class="child-comment-footer text-right clearfix">
      
      <a data-id="1243652" data-nickname="小鄧子" class="reply" href="javascript:void(null)">回复</a>
      
      
      <span class="reply-time pull-left">
        <a href="http://www.jianshu.com/p/92a61357164b/comments/1243665#comment-1243665">2016.01.16 00:21</a></span>
      
    </div>
  </div>

      <div data-state="remaining-child-comments"></div>
        <div class="comment-toolbar clearfix">
          <span class="pull-right">
            <a data-id="1243652" class="reply" href="javascript:void(null)"><i class="fa fa-pencil"></i> 添加新回复</a>
          </span>
        </div>
    </div>
  </div>
</div>

<div class="note-comment clearfix" id="comment-1243707">
  <div class="content">
      <div class="meta-top">
        <a class="avatar" href="http://www.jianshu.com/users/ec59bd61433a">
          <img src="./OkHttp3源码分析[复用连接池] - 简书_files/60959ccfd3fb" alt="100">
</a>        <p>
          <a class="author-name" href="http://www.jianshu.com/users/ec59bd61433a">程序亦非猿</a>
        </p>
        <span class="reply-time">
          <small>3 楼 · </small>
          <a href="http://www.jianshu.com/p/92a61357164b/comments/1243707#comment-1243707">2016.01.16 00:29</a></span>
      </div>
      <p>期待下一篇</p>
      <div class="comment-footer clearfix text-right">
        <a data-id="1243707" class="like pull-left" href="javascript:void(0)">
          <i class="fa fa-heart-o"></i>喜欢<span>(0)</span>
</a>        

        <a data-id="1243707" data-nickname="程序亦非猿" class="reply" href="javascript:void(0)">回复</a>
        
        
      </div>
    <div class="child-comment-list hide">
      
      <div data-state="remaining-child-comments"></div>
    </div>
  </div>
</div>

<div class="note-comment clearfix" id="comment-1301857">
  <div class="content">
      <div class="meta-top">
        <a class="avatar" href="http://www.jianshu.com/users/c1b9d1faa7b5">
          <img src="./OkHttp3源码分析[复用连接池] - 简书_files/04777e99a3be.png" alt="100">
</a>        <p>
          <a class="author-name" href="http://www.jianshu.com/users/c1b9d1faa7b5">MrFu</a>
        </p>
        <span class="reply-time">
          <small>4 楼 · </small>
          <a href="http://www.jianshu.com/p/92a61357164b/comments/1301857#comment-1301857">2016.01.23 15:44</a></span>
      </div>
      <p>pruneAndGetAllocationCount 方法里有这么一段<br><br>// We've discovered a leaked allocation. This is an application bug.<br>      Internal.logger.warning("A connection to " + connection.route().address().url()<br>          + " was leaked. Did you forget to close a response body?");<br><br><br>然后做了 references.remove(i);   是不是表明 它已经帮我们把这个泄露给移除了呢</p>
      <div class="comment-footer clearfix text-right">
        <a data-id="1301857" class="like pull-left" href="javascript:void(0)">
          <i class="fa fa-heart-o"></i>喜欢<span>(0)</span>
</a>        

        <a data-id="1301857" data-nickname="MrFu" class="reply" href="javascript:void(0)">回复</a>
        
        
      </div>
    <div class="child-comment-list ">
        <div class="child-comment" id="comment-1302360" data-id="1302360">
    <p>
      <a class="blue-link" href="http://www.jianshu.com/users/b99b0edd4e77">BlackSwift</a>：
      <a href="http://www.jianshu.com/users/c1b9d1faa7b5" class="maleskine-author" target="_blank" data-user-slug="c1b9d1faa7b5">@MrFu</a> 是的，我把警告相关代码给精简了，okhttp可以自动关闭泄漏的连接，因为清理线程池是while(true)不断执行的<br>
    </p>
    <div class="child-comment-footer text-right clearfix">
      
      <a data-id="1301857" data-nickname="BlackSwift" class="reply" href="javascript:void(null)">回复</a>
      
      
      <span class="reply-time pull-left">
        <a href="http://www.jianshu.com/p/92a61357164b/comments/1302360#comment-1302360">2016.01.23 17:18</a></span>
      
    </div>
  </div>

      <div data-state="remaining-child-comments"></div>
        <div class="comment-toolbar clearfix">
          <span class="pull-right">
            <a data-id="1301857" class="reply" href="javascript:void(null)"><i class="fa fa-pencil"></i> 添加新回复</a>
          </span>
        </div>
    </div>
  </div>
</div>

<div class="note-comment clearfix" id="comment-1332160">
  <div class="content">
      <div class="meta-top">
        <a class="avatar" href="http://www.jianshu.com/users/ec509f634662">
          <img src="./OkHttp3源码分析[复用连接池] - 简书_files/91ce7d00783d" alt="100">
</a>        <p>
          <a class="author-name" href="http://www.jianshu.com/users/ec509f634662">小范屯</a>
        </p>
        <span class="reply-time">
          <small>5 楼 · </small>
          <a href="http://www.jianshu.com/p/92a61357164b/comments/1332160#comment-1332160">2016.01.27 20:12</a></span>
      </div>
      <p>if (longestIdleDurationNs &gt;= this.keepAliveDurationNs<br>|| idleConnectionCount &gt; this.maxIdleConnections)<br><br>应该是keepalive时间大于5分钟或者空闲连接大于5。就进行清除吧</p>
      <div class="comment-footer clearfix text-right">
        <a data-id="1332160" class="like pull-left" href="javascript:void(0)">
          <i class="fa fa-heart-o"></i>喜欢<span>(0)</span>
</a>        

        <a data-id="1332160" data-nickname="小范屯" class="reply" href="javascript:void(0)">回复</a>
        
        
      </div>
    <div class="child-comment-list ">
        <div class="child-comment" id="comment-1332818" data-id="1332818">
    <p>
      <a class="blue-link" href="http://www.jianshu.com/users/b99b0edd4e77">BlackSwift</a>：
      <a href="http://www.jianshu.com/users/ec509f634662" class="maleskine-author" target="_blank" data-user-slug="ec509f634662">@ec509f634662</a> 是的，非常感谢指正，已经修改部分内容。这里还要强调一下“并发连接”==“活跃连接” ＋ “空闲连接”。而不是说，并发的连接时刻都在活跃工作。
    </p>
    <div class="child-comment-footer text-right clearfix">
      
      <a data-id="1332160" data-nickname="BlackSwift" class="reply" href="javascript:void(null)">回复</a>
      
      
      <span class="reply-time pull-left">
        <a href="http://www.jianshu.com/p/92a61357164b/comments/1332818#comment-1332818">2016.01.27 21:49</a></span>
      
    </div>
  </div>

      <div data-state="remaining-child-comments"></div>
        <div class="comment-toolbar clearfix">
          <span class="pull-right">
            <a data-id="1332160" class="reply" href="javascript:void(null)"><i class="fa fa-pencil"></i> 添加新回复</a>
          </span>
        </div>
    </div>
  </div>
</div>


</div>
          <p class="signout-comment">
    <a class="btn btn-info" data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in">
      登录后发表评论
</a>  </p>

    </div>
    <!-- -->

  </div>

  <script type="application/json" data-name="note">
    {"id":2840763,"abbr":"OkHttp系列文章如下OkHttp3源码分析[综述]OkHttp3源码分析[复用连接池]OkHttp3源码分析[缓存策略]OkHttp3源码分析[DiskLruCache]OkHttp3源码分析[任务队列]1.概述HTTP中的keepalive连接在网络性能优化中，对于延迟降低与速度提升的有非常重要的作用。通常我们进行http连接时，首先进行tcp握手，然后传输数据，最后释放图源:Nginxclosed这种方法的确简单，但是在复杂的网络内容中就不够用了，创建socket需要...","slug":"92a61357164b","url":"http://www.jianshu.com/p/92a61357164b","image_url":"http://cwb.assets.jianshu.io/notes/images/2840763/weibo/image_638336a9507b.jpg","wordage":2897,"has_further_readings":false,"views_count":2237,"likes_count":21,"comments_count":8,"rewards_total_count":4}
  </script>

  <script type="application/json" data-name="uuid">
    {"uuid":"7173d290-0b58-0134-a551-52540088e616"}
  </script>

  <script type="application/json" data-name="author">
    {"id":98641,"nickname":"BlackSwift","slug":"b99b0edd4e77","public_notes_count":68,"followers_count":1180,"total_likes_count":1411,"is_current_user":false,"is_signed_author":false}
  </script>


    <div class="include-collection">
      <div class="content">
        <h5>被以下专题收入，发现更多相似内容：</h5>
        <ul id="all-collections" class="unstyled collections-list">
            <li>
              <a class="avatar" href="http://www.jianshu.com/collection/58b4c20abf2f"><img src="./OkHttp3源码分析[复用连接池] - 简书_files/android.graphics.Bitmap_1329dce8.jpeg" alt="180"></a>              <div class="collections-info">
                <h5>
                  <a href="http://www.jianshu.com/collection/58b4c20abf2f">Android技术知识</a>
                </h5>
                
  <div class="btn btn-success follow">
    <a data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in"><i class="fa fa-fw fa-plus"></i>  <span>添加关注</span></a>
    <span>1.9K</span>
  </div>

                <p class="description">Android深入理解、基础详解及各种Library使用介绍。认真做技术，好好享受人生。。</p>
                <p>
                  <a class="blue-link" href="http://www.jianshu.com/collection/58b4c20abf2f">1377篇文章</a> · 1942人关注
                </p>
              </div>
            </li>
            <li>
              <a class="avatar" href="http://www.jianshu.com/collection/0dc880a2c73c"><img src="./OkHttp3源码分析[复用连接池] - 简书_files/ff55916a6a0c2db84ebb1ffdcef539dd.png" alt="180"></a>              <div class="collections-info">
                <h5>
                  <a href="http://www.jianshu.com/collection/0dc880a2c73c">Android开发</a>
                </h5>
                
  <div class="btn btn-success follow">
    <a data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in"><i class="fa fa-fw fa-plus"></i>  <span>添加关注</span></a>
    <span>1.3K</span>
  </div>

                <p class="description">Android开发</p>
                <p>
                  <a class="blue-link" href="http://www.jianshu.com/collection/0dc880a2c73c">947篇文章</a> · 1336人关注
                </p>
              </div>
            </li>
            <li>
              <a class="avatar" href="http://www.jianshu.com/collection/2ac25f6acadb"><img src="./OkHttp3源码分析[复用连接池] - 简书_files/android.graphics.Bitmap_c8bef33.jpeg" alt="180"></a>              <div class="collections-info">
                <h5>
                  <a href="http://www.jianshu.com/collection/2ac25f6acadb">Android 轮子</a>
                </h5>
                
  <div class="btn btn-success follow">
    <a data-signin-link="true" data-toggle="modal" href="http://www.jianshu.com/sign_in"><i class="fa fa-fw fa-plus"></i>  <span>添加关注</span></a>
    <span>641</span>
  </div>

                <p class="description">虽然你不造轮子，但是你要知道轮子怎么造</p>
                <p>
                  <a class="blue-link" href="http://www.jianshu.com/collection/2ac25f6acadb">80篇文章</a> · 641人关注
                </p>
              </div>
            </li>
        </ul>
      </div>
    </div>

  <!-- Modal -->
    <div class="modal pay-modal text-center hide fade" id="pay-modal">
  <div class="modal-header clearfix">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
  </div>
  <form id="new_reward" class="new_reward" target="_blank" action="http://www.jianshu.com/notes/2840763/rewards" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="✓"><input type="hidden" name="authenticity_token" value="FR4Y/Amf4GJjsGlvO9yqlfaPZ16JGI9uXqPEI4TuBX2s9fXGuVAakH6qEI4ddIoQo14etOITaGVbBjKwfltBDA==">
    <div class="modal-body">
      <a href="http://www.jianshu.com/users/b99b0edd4e77">
        <div class="avatar"><img src="./OkHttp3源码分析[复用连接池] - 简书_files/f18dde4989b6.jpeg" alt="100"></div>
</a>      <p><i class="fa fa-quote-left pull-left"></i>打赏也是按照基本法！当然读者的意见也吼重要👓<i class="fa fa-quote-right pull-right"></i></p>
      <div class="main-inputs text-left">
        <div class="control-group">
          <label for="reward_amount">打赏金额</label><i class="fa fa-yen"></i>
          <input value="2.00" type="text" name="reward[amount_in_yuan]" id="reward_amount_in_yuan">
        </div>
        <div class="control-group message">
          <textarea placeholder="给Ta留言" name="reward[message]" id="reward_message"></textarea>
        </div>
      </div>
      <div class="choose-pay text-left">
        <h5>选择支付方式：</h5>
        <div>
          <label for="reward_channel_alipay">
            <div class="iradio_minimal checked" style="position: relative;"><input type="radio" value="alipay" checked="checked" name="reward[channel]" id="reward_channel_alipay" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; border: 0px; opacity: 0; background: rgb(255, 255, 255);"></ins></div>
            <span class="alipay-bg"></span>
</label>
          
          <label for="reward_channel_wx_pub_qr">
            <div class="iradio_minimal" style="position: relative;"><input type="radio" value="wx_pub_qr" name="reward[channel]" id="reward_channel_wx_pub_qr" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; border: 0px; opacity: 0; background: rgb(255, 255, 255);"></ins></div>
            微信支付
</label>        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button name="button" type="submit" class="btn btn-large btn-pay">立即支付</button>
    </div>
</form></div>

    <div class="modal success-pay text-center hide fade" id="success-pay">
  <div class="modal-header clearfix">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
  </div>
  <div class="modal-body">
    <h3><i class="icon-ok"></i>打赏成功</h3>
    <img src="./OkHttp3源码分析[复用连接池] - 简书_files/complete-pay-25426877089eb23bd76d9d0e6aad89c1.png" alt="Complete pay">
  </div>
  <div class="modal-footer">
    
  </div>
</div>

</div>

  <div class="imagebubble-backmask image-package" style="z-index: 1000; top: 0px; width: 0px; height: 0px; display: none;"><div class="image-caption" style="top: 811.609px; margin-left: -94.4px;">图源: Nginx closed</div><div class="image-caption">图源: Nginx keep_alive</div><img class="imagebubble-ghost" src="./OkHttp3源码分析[复用连接池] - 简书_files/98641-9c8a016af59f675f(1).png" scale="10" style="transform: scale(1); top: 694.2px; left: 62.7px; width: 620px; height: 45px;"><img class="imagebubble-ghost" src="./OkHttp3源码分析[复用连接池] - 简书_files/98641-71b1fdaf78b8442c(1).png" style="top: 1069.8px; left: 62.7px; width: 620px; height: 98px;"></div></div>
  <div id="flash" class="hide"></div>
  
  <div id="view-mode-modal" tabindex="-1" class="modal hide read-modal" aria-hidden="false" data-js-module="view-mode-modal">
    <div class="btn-group change-background" data-toggle="buttons-radio">
      <a class="btn btn-daytime active" data-mode="day" href="javascript:void(null);">
        <i class="fa fa-sun-o"></i>
</a>      <a class="btn btn-nighttime " data-mode="night" href="javascript:void(null);">
        <i class="fa fa-moon-o"></i>
</a>    </div>
    <div class="btn-group change-font" data-toggle="buttons-radio">
      <a class="btn font " data-font="font1" href="javascript:void(null);">宋体</a>
      <a class="btn font hei active" data-font="font2" href="javascript:void(null);">黑体</a>
    </div>
    <div class="btn-group change-locale" data-toggle="buttons-radio">
      <a class="btn font active" data-locale="zh-CN" href="javascript:void(null);">简</a>
      <a class="btn font hei " data-locale="zh-TW" href="javascript:void(null);">繁</a>
    </div>
  </div>

  

  <script src="./OkHttp3源码分析[复用连接池] - 简书_files/base-d3f9a709e5a4537b87b3eff40e94a46e.js"></script>
  
  <script src="./OkHttp3源码分析[复用连接池] - 简书_files/reading-base-9132a81390eb5b2cc4f21734b0e9cd08.js"></script>
  <script src="./OkHttp3源码分析[复用连接池] - 简书_files/note_show-12e94137c3593b4c6278c57fead5ad33.js"></script>
  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35169517-1']);
  _gaq.push(['_setCustomVar', 2, 'User Type', 'Visitor', 1 ]);
  _gaq.push(['_trackPageview']);

  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<script>
(function(){
    var bp = document.createElement('script');
    bp.src = '//push.zhanzhang.baidu.com/push.js';
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


</body></html>